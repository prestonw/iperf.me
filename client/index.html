<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>iperf.me â€” MVP</title>
<link rel="stylesheet" href="vendor/xterm/xterm.min.css">
<style>
  body { margin:0; background:#0b0e12; color:#e6edf3; font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace }
  header { padding:12px 16px; border-bottom:1px solid #1d2633; display:flex; gap:12px; align-items:center }
  .badge { background:#142033; padding:4px 8px; border-radius:6px; font-size:12px; color:#a5b4c4 }
  #terminal { height: calc(100vh - 54px) }
  a { color:#69b8ff; text-decoration:none }
  a:hover { text-decoration:underline }
  .sep { opacity:.5 }
</style>

<header>
  <strong>iperf.me</strong>
  <span class="sep">|</span>
  <span class="badge">iPerf.me (edge-friendly, iPerf-style)</span>
  <span style="margin-left:auto;font-size:12px;">Inspired by iPerf3 (BSD, ESnet). Not affiliated.</span>
</header>
<div id="terminal"></div>

<!-- Load xterm + fit addon -->
<script defer src="vendor/xterm/xterm.min.js"></script>
<script defer src="vendor/xterm/xterm-addon-fit.js"></script>

<script>
let WORKER = 'https://edge.iperf.me';
try {
  const u = new URL(location.href);
  const o = u.searchParams.get('worker');
  if (o) WORKER = o;
} catch {}

function start() {
  if (!(window.Terminal && window.FitAddon)) {
    document.getElementById('terminal').textContent =
      'Failed to load terminal assets (CDN blocked?).';
    return;
  }

  const term = new Terminal({ theme:{ background:'#0b0e12' }, scrollback:500 });
  const fitAddon = new FitAddon.FitAddon();
  term.loadAddon(fitAddon);
  term.open(document.getElementById('terminal'));
  fitAddon.fit();
  addEventListener('resize', () => fitAddon.fit());

  const writelnWrapped = (s) => {
    const max = Math.max(1, term.cols - 1);
    for (let i = 0; i < s.length; i += max) term.writeln(s.slice(i, i + max));
  };
  const line = writelnWrapped;
  const pad = (n,w)=>{ n=String(n); return n.length>=w?n:' '.repeat(w-n.length)+n };

  async function runOnce(dir, sizeMB=10){
    const bytes = sizeMB * 1024 * 1024;
    const t0 = performance.now();
    if (dir === 'upload') {
      // zero-filled body (fast; no browser compression)
      const payload = new Uint8Array(bytes);
      await fetch(WORKER + '/upload', { method:'POST', body: payload });
    } else {
      const r = await fetch(WORKER + '/download?bytes=' + bytes);
      await r.arrayBuffer();
    }
    const dur = (performance.now() - t0) / 1000;
    const mbps = (bytes*8/1e6)/dur;
    const hdr = dir==='upload' ? 'snd' : 'rcv';
    line(`[SUM]  0.00-${dur.toFixed(2)} sec  ${pad((bytes/1e6).toFixed(2),7)} MB  ${pad(mbps.toFixed(1),7)} Mbit/s  ${hdr}`);
  }

  (async()=>{
    line('$ iperf3 -c edge-auto -t 10 -P 2');
    line('[ ID]   Interval         Transfer     Bitrate');
    line('[SUM]   0.00-?           (calculating)');
    try {
      line('> Starting 10 MB upload test...');
      await runOnce('upload', 10);
      line('> Starting 10 MB download test...');
      await runOnce('download', 10);
      line('> Done.');
    } catch (e) {
      line('Error: ' + (e?.message || e));
    }
  })();
}

addEventListener('DOMContentLoaded', start);
</script>